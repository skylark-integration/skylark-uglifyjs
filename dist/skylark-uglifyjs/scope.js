/**
 * skylark-uglifyjs - A version of uglifyjs that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["./utils","./ast","./parse"],function(R,V,q){"use strict";const{defaults:n,find_if:B,member:I,push_uniq:p,return_false:j,return_this:W,DEF_BITPROPS:K,makePredicate:t,Dictionary:f}=R,{AST_Arrow:N,AST_Assign:U,AST_AsyncArrow:Y,AST_Block:z,AST_Catch:G,AST_Conditional:J,AST_DefClass:Q,AST_Definitions:X,AST_DefaultValue:Z,AST_Defun:$,AST_Destructured:m,AST_DestructuredKeyVal:ee,AST_Dot:a,AST_ExportDeclaration:v,AST_ForEnumeration:ne,AST_IterationStatement:te,AST_Label:g,AST_LabeledStatement:u,AST_Lambda:b,AST_LambdaDefinition:T,AST_LambdaExpression:ae,AST_LoopControl:ie,AST_Node:re,AST_PropAccess:se,AST_Scope:S,AST_Sequence:i,AST_String:oe,AST_Sub:ce,AST_SwitchBranch:fe,AST_Symbol:E,AST_SymbolCatch:D,AST_SymbolClass:ue,AST_SymbolConst:A,AST_SymbolDeclaration:le,AST_SymbolDefClass:de,AST_SymbolDefun:k,AST_SymbolFunarg:w,AST_SymbolImport:_e,AST_SymbolLambda:y,AST_SymbolLet:O,AST_SymbolRef:he,AST_SymbolVar:F,AST_Toplevel:l,AST_Try:pe,AST_VarDef:me,AST_With:ve,TreeWalker:e,walk_body:M,walk_lambda:ge,AST_BlockScope:H,AST_Unary:be,is_arrow:Te}=V,d=q["RESERVED_WORDS"];function r(e,n,t,a){this._bits=0,this.defun=void 0,this.eliminated=0,this.id=e,this.init=a,this.mangled_name=null,this.name=t.name,this.orig=[t],this.references=[],this.replaced=0,this.safe_ids=void 0,this.scope=n}function Se(e){return e.orig[0]instanceof w||e.orig[1]instanceof w}r.prototype={forEach:function(e){this.orig.forEach(e),this.references.forEach(e)},mangle:function(e){var n,t;this.mangled_name||((n=this.global&&e.cache&&e.cache.props)&&n.has(this.name)?this.mangled_name=n.get(this.name):this.unmangleable(e)?_(this.scope,e).set(this.name,!0):(t=this.redefined(),this.mangled_name=t?t.mangled_name||t.name:function(e,t){var n,a=e.scope,i=_(a,t),r=a.cname_holes,s=new f,o=[a];e.forEach(function(e){var n=e.scope;do{if(I(n,o))break;_(n,t).each(function(e,n){s.set(n,e)}),o.push(n)}while(n=n.parent_scope)});for(var c=0;c<r.length;c++)if(n=L(r[c]),!s.has(n))return r.splice(c,1),i.set(n,!0),n;for(;;)if(n=L(++a.cname),!(i.has(n)||d[n]||t.reserved.has[n])){if(!s.has(n))break;r.push(a.cname)}return i.set(n,!0),n}(this,e),n&&n.set(this.name,this.mangled_name)))},redefined:function(){var n,e=this.defun;if(e)return n=this.name,(e=e.variables.get(n)||e instanceof l&&e.globals.get(n)||this.orig[0]instanceof A&&B(function(e){return e.name==n},e.enclosed))&&e!==this?e.redefined()||e:void 0},unmangleable:function(e){if(this.exported)return!0;if(this.undeclared)return!0;if(!e.eval&&this.scope.pinned())return!0;if(e.keep_fargs&&Se(this))return!0;if(e.keep_fnames){var n=this.orig[0];if(n instanceof ue)return!0;if(n instanceof de)return!0;if(n instanceof k)return!0;if(n instanceof y)return!0}return!(e.toplevel||!this.global)}},K(r,["const_redefs","cross_loop","direct_access","exported","global","undeclared"]);var Ee=t("delete ++ --");function De(e,n){return n instanceof U?n.left===e&&e:n instanceof Z?n.name===e&&e:n instanceof m||n instanceof ee?e:n instanceof ne?n.init===e&&e:n instanceof be?Ee[n.operator]&&n.expression:void 0}function Ae(e,n){e.enclosed=[],e.parent_scope=n,e.functions=new f,e.variables=new f,n&&(e.make_def=n.make_def)}function s(e,n){Ae(e,n),e.uses_eval=!1,e.uses_with=!1}function _(e,n){var t,a=e.names_in_use;return a||(e.cname=-1,e.cname_holes=[],e.names_in_use=a=new f,t=n.cache&&n.cache.props,e.enclosed.forEach(function(e){e.unmangleable(n)&&a.set(e.name,!0),e.global&&t&&t.has(e.name)&&a.set(t.get(e.name),!0)})),a}function h(e){return e=n(e,{eval:!1,ie:!1,keep_fargs:!1,keep_fnames:!1,reserved:[],toplevel:!1,v8:!1,webkit:!1}),Array.isArray(e.reserved)||(e.reserved=[]),p(e.reserved,"arguments"),e.reserved.has=t(e.reserved),e}l.DEFMETHOD("figure_out_scope",function(u){u=n(u,{cache:null,ie:!1});var l=this,s=null,o=!1,t=0,c=l.parent_scope=null,d=new e(function(a,e){var n,t;if(a instanceof Q)return n=o,o=d.parent()instanceof v,a.name.walk(d),o=n,r(function(){a.extends&&a.extends.walk(d),a.properties.forEach(function(e){e.walk(d)})}),!0;if(a instanceof X)return n=o,o=d.parent()instanceof v,e(),o=n,!0;if(a instanceof T)return n=o,o=d.parent()instanceof v,a.name.walk(d),o=n,r(function(){a.argnames.forEach(function(e){e.walk(d)}),a.rest&&a.rest.walk(d),M(a,d)}),!0;if(a instanceof fe)return a.init_vars(c),e(),!0;if(a instanceof pe)return r(function(){M(a,d)}),a.bcatch&&a.bcatch.walk(d),a.bfinally&&a.bfinally.walk(d),!0;if(a instanceof ve){for(var i=c;!(i=i.resolve()).uses_with&&(i.uses_with=!0,i=i.parent_scope););return r(e),!0}if(a instanceof H)return r(e),!0;function r(e){a.init_vars(c);var n=s,t=c;a instanceof S&&(s=a),c=a,e(),c=t,s=n}a instanceof E&&(a.scope=c),a instanceof g&&((a.thedef=a).references=[]),a instanceof D?c.def_variable(a).defun=s:a instanceof A?((t=c.def_variable(a)).defun=s,o&&(t.exported=!0)):a instanceof k?(t=s.def_function(a,d.parent()),o&&(t.exported=!0)):a instanceof w?s.def_variable(a):a instanceof y?(t=s.def_function(a,"arguments"==a.name?void 0:s),u.ie&&"arguments"!=a.name&&(t.defun=s.parent_scope.resolve())):a instanceof O?(t=c.def_variable(a),o&&(t.exported=!0)):a instanceof F&&(t=s.def_variable(a,a instanceof _e?void 0:null),o)&&(t.exported=!0)}),_=(l.make_def=function(e,n){return new r(++t,this,e,n)},l.walk(d),l.globals=new f,[]),d=new e(function(e){if(e instanceof G)return e.argname instanceof m?(_.push(e),e.argname.walk(d),_.pop(),M(e,d),!0):void 0;if(e instanceof b)return _.push(e),e.name&&e.name.walk(d),e.argnames.forEach(function(e){e.walk(d)}),e.rest&&e.rest.walk(d),_.pop(),ge(e,d),!0;if(e instanceof ie)return e.label&&e.label.thedef.references.push(e),!0;if(e instanceof le){var n,t=e.definition();if(t.preinit=t.references.length,e instanceof D){if(n=t.redefined())for(var a=e.scope;a&&p(a.enclosed,n)&&a!==n.scope;a=a.parent_scope);}else e instanceof A?(n=t.redefined())&&(n.const_redefs=!0):t.scope!==e.scope&&(e instanceof k||e instanceof w||e instanceof F)&&(e.mark_enclosed(u),n=e.scope.find_variable(e.name),e.thedef!==n)&&((e.thedef=n).orig.push(e),e.mark_enclosed(u));return"arguments"!=e.name||(i=e instanceof F&&d.parent())instanceof me&&!i.value||(s=e.scope.resolve().find_variable("arguments"))&&h(s)&&(s.scope.uses_arguments=3),!0}if(e instanceof he){for(var i,r=e.name,s=e.scope.find_variable(r),o=_.length;0<o&&s&&!((o=_.lastIndexOf(s.scope,o-1))<0);){var c=s.orig[0];if(c instanceof D||c instanceof w||c instanceof y){e.in_arg=!0;break}s=s.scope.parent_scope.find_variable(r)}if(s?"arguments"==r&&h(s)&&(De(e,i=d.parent())?s.scope.uses_arguments=3:s.scope.uses_arguments<2&&!(i instanceof se&&i.expression===e)?s.scope.uses_arguments=2:s.scope.uses_arguments||(s.scope.uses_arguments=!0)):s=l.def_global(e),"eval"==r)if("Call"==(i=d.parent()).TYPE&&i.expression===e)for(a=e.scope;!(a=a.resolve()).uses_eval&&(a.uses_eval=!0,a=a.parent_scope););else s.undeclared&&(l.uses_eval=!0);if(s.init instanceof T&&s.scope!==s.init.name.scope){var f=e.scope;do{if(f===s.init.name.scope)break}while(f=f.parent_scope);f||(s.init=void 0)}return e.thedef=s,e.reference(u),!0}});function h(e){return e.orig[0]instanceof w&&!(e.orig[1]instanceof w||e.orig[2]instanceof w)&&!Te(e.scope)}function a(e,n){var t,a,i=e.name,r=e.thedef;if(all(r.orig,function(e){return!(e instanceof A||e instanceof O)}))return(t=n.find_variable(i))?(a=t.redefined())&&(t=a):t=l.globals.get(i),t?t.orig.push(e):t=n.def_variable(e),t.undeclared&&l.variables.set(i,t),"arguments"==i&&h(r)&&e instanceof y||(r.defun=t.scope,r.forEach(function(e){e.redef=r,e.thedef=t,e.reference(u)})),1}l.walk(d),u.ie&&l.walk(new e(function(e){var n,t;return e instanceof D?(n=(t=e.thedef).defun,a(e,n="arguments"!=t.name&&n.name instanceof y&&n.name.name==t.name?n.parent_scope.resolve():n),!0):e instanceof y?(t=e.thedef,a(e,e.scope.parent_scope.resolve())?void 0!==e.thedef.init?e.thedef.init=!1:t.init&&(e.thedef.init=t.init):t.defun=void 0,!0):void 0}))}),l.DEFMETHOD("def_global",function(e){var n=this.globals,t=e.name;return n.has(t)?n.get(t):((e=this.make_def(e)).undeclared=!0,e.global=!0,n.set(t,e),e)}),H.DEFMETHOD("init_vars",function(e){Ae(this,e)}),S.DEFMETHOD("init_vars",function(e){s(this,e)}),N.DEFMETHOD("init_vars",function(e){return s(this,e),this}),Y.DEFMETHOD("init_vars",function(e){s(this,e)}),b.DEFMETHOD("init_vars",function(e){return s(this,e),this.uses_arguments=!1,this.def_variable(new w({name:"arguments",scope:this,start:this.start,end:this.end})),this}),E.DEFMETHOD("mark_enclosed",function(e){for(var n=this.definition(),t=this.scope;t&&p(t.enclosed,n)&&(e?(e.keep_fargs&&t instanceof b&&t.each_argname(function(e){p(n.scope.enclosed,e.definition())}),e.keep_fnames&&t.functions.each(function(e){p(n.scope.enclosed,e)})):t._var_names=void 0,t!==n.scope);t=t.parent_scope);}),E.DEFMETHOD("reference",function(e){this.definition().references.push(this),this.mark_enclosed(e)}),H.DEFMETHOD("find_variable",function(e){return this.variables.get(e)||this.parent_scope&&this.parent_scope.find_variable(e)}),H.DEFMETHOD("def_function",function(e,n){var t=this.def_variable(e,n);return(!t.init||t.init instanceof T)&&(t.init=n),this.functions.set(e.name,t),t}),H.DEFMETHOD("def_variable",function(e,n){var t=this.variables.get(e.name);return t?(t.orig.push(e),t.init instanceof ae&&(t.init=n)):(t=this.make_def(e,n),this.variables.set(e.name,t),t.global=!this.parent_scope),e.thedef=t}),E.DEFMETHOD("unmangleable",function(e){var n=this.definition();return!n||n.unmangleable(e)}),g.DEFMETHOD("unmangleable",j),E.DEFMETHOD("definition",function(){return this.thedef}),l.DEFMETHOD("mangle_names",function(r){(r=h(r)).cache&&r.cache.props&&(n=_(this,r),r.cache.props.each(function(e){n.set(e,!0)}));var n,s=-1,o=[],c=new e(function(e,n){var t,a,i;if(e instanceof H)return e instanceof u&&(t=s),r.webkit&&e instanceof te&&e.init instanceof AST_Let&&e.init.definitions.forEach(function(e){e.name.match_symbol(function(e){var n,t,a;e instanceof O&&(n=e.definition(),t=e.scope.parent_scope,a=t.def_variable(e),e.thedef=n,t.to_mangle.push(a),n.redefined=function(){return a})})},!0),a=e.to_mangle=[],e.variables.each(function(e){!function(n){var e=n.orig[0],t=n.redefined();if(!t){if(!(e instanceof A))return;var a=n.scope.resolve();if(n.scope===a)return;if(n.scope.parent_scope.find_variable(e.name))return;t=a.def_variable(e),a.to_mangle.push(t)}o.push(n),n.references.forEach(i),(e instanceof D||e instanceof A)&&(i(e),n.redefined=function(){return t});return 1;function i(e){e.thedef=t,e.reference(r),e.thedef=n}}(e)&&a.push(e)}),n(),r.cache&&e instanceof l&&e.globals.each(f),e instanceof $&&c.has_directive("use asm")&&((n=new he(e.name)).scope=e,n.reference(r)),(a=36<a.length?(n=a.map(function(e,n){return n}).sort(function(e,n){return a[n].references.length-a[e].references.length||e-n})).slice(0,36).sort(function(e,n){return e-n}).map(function(e){return a[e]}).concat(n.slice(36).sort(function(e,n){return e-n}).map(function(e){return a[e]})):a).forEach(f),!(e instanceof u)||r.v8&&function(e){var n,t=0;for(;n=e.parent(t++);){if(n instanceof z)return n instanceof l&&!r.toplevel;if(n instanceof u)return 1}}(c)||(s=t),!0;if(e instanceof g){for(;i=L(++s),d[i];);return e.mangled_name=i,!0}});function f(e){r.reserved.has[e.name]||e.mangle(r)}this.walk(c),o.forEach(f)}),l.DEFMETHOD("find_colliding_names",function(t){var a=t.cache&&t.cache.props,n=Object.create(d);return t.reserved.forEach(i),this.globals.each(r),this.walk(new e(function(e){e instanceof H&&e.variables.each(r)})),n;function i(e){n[e]=!0}function r(e){var n=e.name;if(e.global&&a&&a.has(n))n=a.get(n);else if(!e.unmangleable(t))return;i(n)}}),l.DEFMETHOD("expand_names",function(a){L.reset(),L.sort(),a=h(a);var i=this.find_colliding_names(a),r=0;function n(n){var e,t;n.global&&a.cache||n.unmangleable(a)||a.reserved.has[n.name]||(e=n.redefined(),t=e?e.rename||e.name:function(){for(var e;e=L(r++),i[e];);return e}(),n.rename=t,n.forEach(function(e){e.definition()===n&&(e.name=t)}))}this.globals.each(n),this.walk(new e(function(e){e instanceof H&&e.variables.each(n)}))}),re.DEFMETHOD("tail_node",W),i.DEFMETHOD("tail_node",function(){return this.expressions[this.expressions.length-1]}),l.DEFMETHOD("compute_char_frequency",function(e){e=h(e),L.reset();var n=E.prototype.add_source_map;try{E.prototype.add_source_map=function(){this.unmangleable(e)||L.consider(this.name,-1)},e.properties&&(a.prototype.add_source_map=function(){L.consider(this.property,-1)},ce.prototype.add_source_map=function(){!function e(n){n instanceof oe?L.consider(n.value,-1):n instanceof J?(e(n.consequent),e(n.alternative)):n instanceof i&&e(n.tail_node())}(this.property)}),L.consider(this.print_to_string(),1)}finally{E.prototype.add_source_map=n,delete a.prototype.add_source_map,delete ce.prototype.add_source_map}L.sort()});o=Object.create(null),ke=we("0123456789"),C=we("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_"),P.consider=function(e,n){for(var t=e.length;0<=--t;)x[e[t]]+=n},P.sort=function(){c=C.sort(Oe).concat(ke).sort(Oe)},(P.reset=ye)();var o,c,x,ke,C,L=P;function we(e){for(var n=[],t=0;t<e.length;t++){var a=e[t];n.push(a),o[a]=-.01*t}return n}function ye(){c=null,x=Object.create(o)}function Oe(e,n){return x[n]-x[e]}function P(e){var n=C[e%54];for(e=Math.floor(e/54);0<=--e;e>>=6)n+=c[63&e];return n}return{base54:L,is_lhs:De,is_funarg:Se,unary_side_effects:Ee}});
//# sourceMappingURL=sourcemaps/scope.js.map
