/**
 * skylark-uglifyjs - A version of uglifyjs that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["./utils","./ast","./parse"],function(e,n,t){"use strict";const{defaults:a,keep_name:i,mergeSort:r,member:s,push_uniq:o,make_node:f,return_false:c,return_this:u,return_true:l,string_template:_,DEF_BITPROPS:d,makePredicate:h,Dictionary:p}=e,{AST_Arrow:m,AST_Assign:v,AST_AsyncArrow:g,AST_Block:b,AST_Call:S,AST_Catch:T,AST_Class:A,AST_Conditional:E,AST_DefClass:D,AST_Definitions:k,AST_DefaultValue:w,AST_Defun:y,AST_Destructuring:F,AST_Destructured:O,AST_DestructuredKeyVal:M,AST_Dot:H,AST_DotHash:x,AST_Export:C,AST_ExportDeclaration:L,AST_For:I,AST_ForIn:R,AST_ForOf:B,AST_ForEnumeration:P,AST_Function:V,AST_Import:q,AST_IterationStatement:j,AST_Label:W,AST_LabeledStatement:N,AST_LabelRef:K,AST_Lambda:U,AST_LambdaDefinition:Y,AST_LoopControl:z,AST_NameMapping:G,AST_Node:J,AST_Scope:Q,AST_Sequence:X,AST_String:Z,AST_Sub:$,AST_Switch:ee,AST_SwitchBranch:ne,AST_Symbol:te,AST_SymbolBlockDeclaration:ae,AST_SymbolCatch:ie,AST_SymbolClass:re,AST_SymbolConst:se,AST_SymbolDeclaration:oe,AST_SymbolDefClass:fe,AST_SymbolDefun:ce,AST_SymbolExport:ue,AST_SymbolFunarg:le,AST_SymbolImport:_e,AST_SymbolLambda:de,AST_SymbolLet:he,AST_SymbolMethod:pe,AST_SymbolRef:me,AST_SymbolVar:ve,AST_Toplevel:ge,AST_Try:be,AST_VarDef:Se,AST_With:Te,TreeWalker:Ae,walk_body:Ee,walk_lambda:De,AST_BlockScope:ke,AST_Unary:we}=n,{RESERVED_WORDS:ye}=t;function Fe(e,n,t,a){this._bits=0,this.defun=void 0,this.eliminated=0,this.id=e,this.init=a,this.mangled_name=null,this.name=t.name,this.orig=[t],this.references=[],this.replaced=0,this.safe_ids=void 0,this.scope=n}Fe.prototype={forEach:function(e){this.orig.forEach(e),this.references.forEach(e)},mangle:function(e){if(!this.mangled_name){var n=this.global&&e.cache&&e.cache.props;if(n&&n.has(this.name))this.mangled_name=n.get(this.name);else if(this.unmangleable(e))Ce(this.scope,e).set(this.name,!0);else{var t=this.redefined();this.mangled_name=t?t.mangled_name||t.name:function(e,n){var t,a=e.scope,i=Ce(a,n),r=a.cname_holes,o=new p,f=[a];e.forEach(function(e){var t=e.scope;do{if(s(t,f))break;Ce(t,n).each(function(e,n){o.set(n,e)}),f.push(t)}while(t=t.parent_scope)});for(var c=0;c<r.length;c++)if(t=Ie(r[c]),!o.has(t))return r.splice(c,1),i.set(t,!0),t;for(;;)if(t=Ie(++a.cname),!(i.has(t)||ye[t]||n.reserved.has[t])){if(!o.has(t))break;r.push(a.cname)}return i.set(t,!0),t}(this,e),n&&n.set(this.name,this.mangled_name)}}},redefined:function(){var e=this.defun;if(e){var n=this.name,t=e.variables.get(n)||e instanceof ge&&e.globals.get(n)||this.orig[0]instanceof se&&find_if(function(e){return e.name==n},e.enclosed);return t&&t!==this?t.redefined()||t:void 0}},unmangleable:function(e){if(this.exported)return!0;if(this.undeclared)return!0;if(!e.eval&&this.scope.pinned())return!0;if(e.keep_fargs&&((n=this).orig[0]instanceof le||n.orig[1]instanceof le))return!0;var n;if(e.keep_fnames){var t=this.orig[0];if(t instanceof re)return!0;if(t instanceof fe)return!0;if(t instanceof ce)return!0;if(t instanceof de)return!0}return!(e.toplevel||!this.global)}},d(Fe,["const_redefs","cross_loop","direct_access","exported","global","undeclared"]);var Oe=h("delete ++ --");function Me(e,n){return n instanceof v?n.left===e&&e:n instanceof w?n.name===e&&e:n instanceof O?e:n instanceof M?e:n instanceof P?n.init===e&&e:n instanceof we?Oe[n.operator]&&n.expression:void 0}function He(e,n){e.enclosed=[],e.parent_scope=n,e.functions=new p,e.variables=new p,n&&(e.make_def=n.make_def)}function xe(e,n){He(e,n),e.uses_eval=!1,e.uses_with=!1}function Ce(e,n){var t=e.names_in_use;if(!t){e.cname=-1,e.cname_holes=[],e.names_in_use=t=new p;var a=n.cache&&n.cache.props;e.enclosed.forEach(function(e){e.unmangleable(n)&&t.set(e.name,!0),e.global&&a&&a.has(e.name)&&t.set(a.get(e.name),!0)})}return t}function Le(e){return e=a(e,{eval:!1,ie:!1,keep_fargs:!1,keep_fnames:!1,reserved:[],toplevel:!1,v8:!1,webkit:!1}),Array.isArray(e.reserved)||(e.reserved=[]),o(e.reserved,"arguments"),e.reserved.has=h(e.reserved),e}ge.DEFMETHOD("figure_out_scope",function(e){e=a(e,{cache:null,ie:!1});var n=this,t=null,i=!1,r=0,s=n.parent_scope=null,f=new Ae(function(n,a){if(n instanceof D){var r=i;return i=f.parent()instanceof L,n.name.walk(f),i=r,u(function(){n.extends&&n.extends.walk(f),n.properties.forEach(function(e){e.walk(f)})}),!0}if(n instanceof k){r=i;return i=f.parent()instanceof L,a(),i=r,!0}if(n instanceof Y){r=i;return i=f.parent()instanceof L,n.name.walk(f),i=r,u(function(){n.argnames.forEach(function(e){e.walk(f)}),n.rest&&n.rest.walk(f),Ee(n,f)}),!0}if(n instanceof ne)return n.init_vars(s),a(),!0;if(n instanceof be)return u(function(){Ee(n,f)}),n.bcatch&&n.bcatch.walk(f),n.bfinally&&n.bfinally.walk(f),!0;if(n instanceof Te){var o=s;do{if((o=o.resolve()).uses_with)break;o.uses_with=!0}while(o=o.parent_scope);return u(a),!0}if(n instanceof ke)return u(a),!0;if(n instanceof te&&(n.scope=s),n instanceof W&&(n.thedef=n,n.references=[]),n instanceof ie)s.def_variable(n).defun=t;else if(n instanceof se){(c=s.def_variable(n)).defun=t,i&&(c.exported=!0)}else if(n instanceof ce){var c=t.def_function(n,f.parent());i&&(c.exported=!0)}else if(n instanceof le)t.def_variable(n);else if(n instanceof de){c=t.def_function(n,"arguments"==n.name?void 0:t);e.ie&&"arguments"!=n.name&&(c.defun=t.parent_scope.resolve())}else if(n instanceof he){c=s.def_variable(n);i&&(c.exported=!0)}else if(n instanceof ve){c=t.def_variable(n,n instanceof _e?void 0:null);i&&(c.exported=!0)}function u(e){n.init_vars(s);var a=t,i=s;n instanceof Q&&(t=n),s=n,e(),s=i,t=a}});n.make_def=function(e,n){return new Fe(++r,this,e,n)},n.walk(f),n.globals=new p;var c=[];f=new Ae(function(t){if(t instanceof T){if(!(t.argname instanceof O))return;return c.push(t),t.argname.walk(f),c.pop(),Ee(t,f),!0}if(t instanceof U)return c.push(t),t.name&&t.name.walk(f),t.argnames.forEach(function(e){e.walk(f)}),t.rest&&t.rest.walk(f),c.pop(),De(t,f),!0;if(t instanceof z)return t.label&&t.label.thedef.references.push(t),!0;if(t instanceof oe){var a=t.definition();if(a.preinit=a.references.length,t instanceof ie){if(r=a.redefined())for(var i=t.scope;i&&o(i.enclosed,r)&&i!==r.scope;i=i.parent_scope);}else if(t instanceof se){(r=a.redefined())&&(r.const_redefs=!0)}else if(a.scope!==t.scope&&(t instanceof ce||t instanceof le||t instanceof ve)){t.mark_enclosed(e);var r=t.scope.find_variable(t.name);t.thedef!==r&&(t.thedef=r,r.orig.push(t),t.mark_enclosed(e))}return"arguments"!=t.name||((h=t instanceof ve&&f.parent())instanceof Se&&!h.value||((l=t.scope.resolve().find_variable("arguments"))&&u(l)&&(l.scope.uses_arguments=3),!0))}if(t instanceof me){for(var s=t.name,l=t.scope.find_variable(s),_=c.length;_>0&&l&&!((_=c.lastIndexOf(l.scope,_-1))<0);){var d=l.orig[0];if(d instanceof ie||d instanceof le||d instanceof de){t.in_arg=!0;break}l=l.scope.parent_scope.find_variable(s)}if(l){if("arguments"==s&&u(l)){var h;Me(t,h=f.parent())?l.scope.uses_arguments=3:l.scope.uses_arguments<2&&!(h instanceof AST_PropAccess&&h.expression===t)?l.scope.uses_arguments=2:l.scope.uses_arguments||(l.scope.uses_arguments=!0)}}else l=n.def_global(t);if("eval"==s)if("Call"==(h=f.parent()).TYPE&&h.expression===t){i=t.scope;do{if((i=i.resolve()).uses_eval)break;i.uses_eval=!0}while(i=i.parent_scope)}else l.undeclared&&(n.uses_eval=!0);if(l.init instanceof Y&&l.scope!==l.init.name.scope){var p=t.scope;do{if(p===l.init.name.scope)break}while(p=p.parent_scope);p||(l.init=void 0)}return t.thedef=l,t.reference(e),!0}});function u(e){return e.orig[0]instanceof le&&!(e.orig[1]instanceof le||e.orig[2]instanceof le)&&!is_arrow(e.scope)}function l(t,a){var i=t.name,r=t.thedef;if(!all(r.orig,function(e){return!(e instanceof se||e instanceof he)}))return!1;var s=a.find_variable(i);if(s){var o=s.redefined();o&&(s=o)}else s=n.globals.get(i);return s?s.orig.push(t):s=a.def_variable(t),s.undeclared&&n.variables.set(i,s),!!("arguments"==i&&u(r)&&t instanceof de)||(r.defun=s.scope,r.forEach(function(n){n.redef=r,n.thedef=s,n.reference(e)}),!0)}n.walk(f),e.ie&&n.walk(new Ae(function(e){if(e instanceof ie){var n=(t=e.thedef).defun;return"arguments"!=t.name&&n.name instanceof de&&n.name.name==t.name&&(n=n.parent_scope.resolve()),l(e,n),!0}if(e instanceof de){var t=e.thedef;return l(e,e.scope.parent_scope.resolve())?void 0!==e.thedef.init?e.thedef.init=!1:t.init&&(e.thedef.init=t.init):t.defun=void 0,!0}}))}),ge.DEFMETHOD("def_global",function(e){var n=this.globals,t=e.name;if(n.has(t))return n.get(t);var a=this.make_def(e);return a.undeclared=!0,a.global=!0,n.set(t,a),a}),ke.DEFMETHOD("init_vars",function(e){He(this,e)}),Q.DEFMETHOD("init_vars",function(e){xe(this,e)}),m.DEFMETHOD("init_vars",function(e){return xe(this,e),this}),g.DEFMETHOD("init_vars",function(e){xe(this,e)}),U.DEFMETHOD("init_vars",function(e){return xe(this,e),this.uses_arguments=!1,this.def_variable(new le({name:"arguments",scope:this,start:this.start,end:this.end})),this}),te.DEFMETHOD("mark_enclosed",function(e){for(var n=this.definition(),t=this.scope;t&&o(t.enclosed,n)&&(e?(e.keep_fargs&&t instanceof U&&t.each_argname(function(e){o(n.scope.enclosed,e.definition())}),e.keep_fnames&&t.functions.each(function(e){o(n.scope.enclosed,e)})):t._var_names=void 0,t!==n.scope);t=t.parent_scope);}),te.DEFMETHOD("reference",function(e){this.definition().references.push(this),this.mark_enclosed(e)}),ke.DEFMETHOD("find_variable",function(e){return this.variables.get(e)||this.parent_scope&&this.parent_scope.find_variable(e)}),ke.DEFMETHOD("def_function",function(e,n){var t=this.def_variable(e,n);return(!t.init||t.init instanceof Y)&&(t.init=n),this.functions.set(e.name,t),t}),ke.DEFMETHOD("def_variable",function(e,n){var t=this.variables.get(e.name);return t?(t.orig.push(e),t.init instanceof AST_LambdaExpression&&(t.init=n)):(t=this.make_def(e,n),this.variables.set(e.name,t),t.global=!this.parent_scope),e.thedef=t}),te.DEFMETHOD("unmangleable",function(e){var n=this.definition();return!n||n.unmangleable(e)}),W.DEFMETHOD("unmangleable",c),te.DEFMETHOD("definition",function(){return this.thedef}),ge.DEFMETHOD("mangle_names",function(e){if((e=Le(e)).cache&&e.cache.props){var n=Ce(this,e);e.cache.props.each(function(e){n.set(e,!0)})}var t=-1,a=[],i=new Ae(function(n,s){var o;if(n instanceof ke){n instanceof N&&(o=t),e.webkit&&n instanceof j&&n.init instanceof AST_Let&&n.init.definitions.forEach(function(e){e.name.match_symbol(function(e){if(e instanceof he){var n=e.definition(),t=e.scope.parent_scope,a=t.def_variable(e);e.thedef=n,t.to_mangle.push(a),n.redefined=function(){return a}}})},!0);var f=n.to_mangle=[];if(n.variables.each(function(n){(function(n){var t=n.orig[0],i=n.redefined();if(!i){if(!(t instanceof se))return!1;var r=n.scope.resolve();if(n.scope===r)return!1;if(n.scope.parent_scope.find_variable(t.name))return!1;i=r.def_variable(t),r.to_mangle.push(i)}a.push(n),n.references.forEach(s),(t instanceof ie||t instanceof se)&&(s(t),n.redefined=function(){return i});return!0;function s(t){t.thedef=i,t.reference(e),t.thedef=n}})(n)||f.push(n)}),s(),e.cache&&n instanceof ge&&n.globals.each(r),n instanceof y&&i.has_directive("use asm")){var c=new me(n.name);c.scope=n,c.reference(e)}if(f.length>36){var u=f.map(function(e,n){return n}).sort(function(e,n){return f[n].references.length-f[e].references.length||e-n});f=u.slice(0,36).sort(function(e,n){return e-n}).map(function(e){return f[e]}).concat(u.slice(36).sort(function(e,n){return e-n}).map(function(e){return f[e]}))}return f.forEach(r),!(n instanceof N)||e.v8&&function(n){var t,a=0;for(;t=n.parent(a++);){if(t instanceof b)return t instanceof ge&&!e.toplevel;if(t instanceof N)return!0}}(i)||(t=o),!0}if(n instanceof W){var l;do{l=Ie(++t)}while(ye[l]);return n.mangled_name=l,!0}});function r(n){e.reserved.has[n.name]||n.mangle(e)}this.walk(i),a.forEach(r)}),ge.DEFMETHOD("find_colliding_names",function(e){var n=e.cache&&e.cache.props,t=Object.create(ye);return e.reserved.forEach(a),this.globals.each(i),this.walk(new Ae(function(e){e instanceof ke&&e.variables.each(i)})),t;function a(e){t[e]=!0}function i(t){var i=t.name;if(t.global&&n&&n.has(i))i=n.get(i);else if(!t.unmangleable(e))return;a(i)}}),ge.DEFMETHOD("expand_names",function(e){Ie.reset(),Ie.sort(),e=Le(e);var n=this.find_colliding_names(e),t=0;function a(a){if(!(a.global&&e.cache||a.unmangleable(e)||e.reserved.has[a.name])){var i=a.redefined(),r=i?i.rename||i.name:function(){var e;do{e=Ie(t++)}while(n[e]);return e}();a.rename=r,a.forEach(function(e){e.definition()===a&&(e.name=r)})}}this.globals.each(a),this.walk(new Ae(function(e){e instanceof ke&&e.variables.each(a)}))}),J.DEFMETHOD("tail_node",u),X.DEFMETHOD("tail_node",function(){return this.expressions[this.expressions.length-1]}),ge.DEFMETHOD("compute_char_frequency",function(e){e=Le(e),Ie.reset();var n=te.prototype.add_source_map;try{te.prototype.add_source_map=function(){this.unmangleable(e)||Ie.consider(this.name,-1)},e.properties&&(H.prototype.add_source_map=function(){Ie.consider(this.property,-1)},$.prototype.add_source_map=function(){!function e(n){n instanceof Z?Ie.consider(n.value,-1):n instanceof E?(e(n.consequent),e(n.alternative)):n instanceof X&&e(n.tail_node())}(this.property)}),Ie.consider(this.print_to_string(),1)}finally{te.prototype.add_source_map=n,delete H.prototype.add_source_map,delete $.prototype.add_source_map}Ie.sort()});var Ie=function(){var e=Object.create(null);function n(n){for(var t=[],a=0;a<n.length;a++){var i=n[a];t.push(i),e[i]=-.01*a}return t}var t,a,i=n("0123456789"),r=n("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_");function s(){t=null,a=Object.create(e)}function o(e,n){return a[n]-a[e]}function f(e){var n=r[e%54];for(e=Math.floor(e/54);--e>=0;e>>=6)n+=t[63&e];return n}return f.consider=function(e,n){for(var t=e.length;--t>=0;)a[e[t]]+=n},f.sort=function(){t=r.sort(o).concat(i).sort(o)},f.reset=s,s(),f}();return{base54:Ie,is_lhs:Me}});
//# sourceMappingURL=sourcemaps/scope.js.map
