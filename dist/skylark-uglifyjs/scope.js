/**
 * skylark-uglifyjs - A version of uglifyjs that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["./utils","./ast","./parse"],function(e,n,t){"use strict";const{defaults:a,keep_name:i,mergeSort:r,member:s,push_uniq:o,make_node:f,return_false:c,return_this:l,return_true:u,string_template:_,DEF_BITPROPS:d,makePredicate:h,Dictionary:p}=e,{AST_Arrow:m,AST_Assign:v,AST_AsyncArrow:g,AST_Block:b,AST_Call:S,AST_Catch:T,AST_Class:A,AST_Conditional:E,AST_DefClass:D,AST_Definitions:k,AST_DefaultValue:w,AST_Defun:y,AST_Destructuring:F,AST_Destructured:O,AST_DestructuredKeyVal:M,AST_Dot:H,AST_DotHash:x,AST_Export:C,AST_For:L,AST_ForIn:I,AST_ForOf:R,AST_ForEnumeration:B,AST_Function:P,AST_Import:V,AST_IterationStatement:q,AST_Label:j,AST_LabeledStatement:W,AST_LabelRef:N,AST_Lambda:K,AST_LambdaDefinition:U,AST_LoopControl:Y,AST_NameMapping:z,AST_Node:G,AST_Scope:J,AST_Sequence:Q,AST_String:X,AST_Sub:Z,AST_Switch:$,AST_SwitchBranch:ee,AST_Symbol:ne,AST_SymbolBlockDeclaration:te,AST_SymbolCatch:ae,AST_SymbolClass:ie,AST_SymbolConst:re,AST_SymbolDeclaration:se,AST_SymbolDefClass:oe,AST_SymbolDefun:fe,AST_SymbolExport:ce,AST_SymbolFunarg:le,AST_SymbolImport:ue,AST_SymbolLambda:_e,AST_SymbolLet:de,AST_SymbolMethod:he,AST_SymbolRef:pe,AST_SymbolVar:me,AST_Toplevel:ve,AST_Try:ge,AST_VarDef:be,AST_With:Se,TreeWalker:Te,walk_body:Ae,walk_lambda:Ee,AST_BlockScope:De,AST_Unary:ke}=n,{RESERVED_WORDS:we}=t;function ye(e,n,t,a){this._bits=0,this.defun=void 0,this.eliminated=0,this.id=e,this.init=a,this.mangled_name=null,this.name=t.name,this.orig=[t],this.references=[],this.replaced=0,this.safe_ids=void 0,this.scope=n}ye.prototype={forEach:function(e){this.orig.forEach(e),this.references.forEach(e)},mangle:function(e){if(!this.mangled_name){var n=this.global&&e.cache&&e.cache.props;if(n&&n.has(this.name))this.mangled_name=n.get(this.name);else if(this.unmangleable(e))xe(this.scope,e).set(this.name,!0);else{var t=this.redefined();this.mangled_name=t?t.mangled_name||t.name:function(e,n){var t,a=e.scope,i=xe(a,n),r=a.cname_holes,o=new p,f=[a];e.forEach(function(e){var t=e.scope;do{if(s(t,f))break;xe(t,n).each(function(e,n){o.set(n,e)}),f.push(t)}while(t=t.parent_scope)});for(var c=0;c<r.length;c++)if(t=Le(r[c]),!o.has(t))return r.splice(c,1),i.set(t,!0),t;for(;;)if(t=Le(++a.cname),!(i.has(t)||we[t]||n.reserved.has[t])){if(!o.has(t))break;r.push(a.cname)}return i.set(t,!0),t}(this,e),n&&n.set(this.name,this.mangled_name)}}},redefined:function(){var e=this.defun;if(e){var n=this.name,t=e.variables.get(n)||e instanceof ve&&e.globals.get(n)||this.orig[0]instanceof re&&find_if(function(e){return e.name==n},e.enclosed);return t&&t!==this?t.redefined()||t:void 0}},unmangleable:function(e){if(this.exported)return!0;if(this.undeclared)return!0;if(!e.eval&&this.scope.pinned())return!0;if(e.keep_fargs&&((n=this).orig[0]instanceof le||n.orig[1]instanceof le))return!0;var n;if(e.keep_fnames){var t=this.orig[0];if(t instanceof ie)return!0;if(t instanceof oe)return!0;if(t instanceof fe)return!0;if(t instanceof _e)return!0}return!(e.toplevel||!this.global)}},d(ye,["const_redefs","cross_loop","direct_access","exported","global","undeclared"]);var Fe=h("delete ++ --");function Oe(e,n){return n instanceof v?n.left===e&&e:n instanceof w?n.name===e&&e:n instanceof O?e:n instanceof M?e:n instanceof B?n.init===e&&e:n instanceof ke?Fe[n.operator]&&n.expression:void 0}function Me(e,n){e.enclosed=[],e.parent_scope=n,e.functions=new p,e.variables=new p,n&&(e.make_def=n.make_def)}function He(e,n){Me(e,n),e.uses_eval=!1,e.uses_with=!1}function xe(e,n){var t=e.names_in_use;if(!t){e.cname=-1,e.cname_holes=[],e.names_in_use=t=new p;var a=n.cache&&n.cache.props;e.enclosed.forEach(function(e){e.unmangleable(n)&&t.set(e.name,!0),e.global&&a&&a.has(e.name)&&t.set(a.get(e.name),!0)})}return t}function Ce(e){return e=a(e,{eval:!1,ie:!1,keep_fargs:!1,keep_fnames:!1,reserved:[],toplevel:!1,v8:!1,webkit:!1}),Array.isArray(e.reserved)||(e.reserved=[]),o(e.reserved,"arguments"),e.reserved.has=h(e.reserved),e}ve.DEFMETHOD("figure_out_scope",function(e){e=a(e,{cache:null,ie:!1});var n=this,t=null,i=!1,r=0,s=n.parent_scope=null,f=new Te(function(n,a){if(n instanceof D){var r=i;return i=f.parent()instanceof AST_ExportDeclaration,n.name.walk(f),i=r,l(function(){n.extends&&n.extends.walk(f),n.properties.forEach(function(e){e.walk(f)})}),!0}if(n instanceof k){r=i;return i=f.parent()instanceof AST_ExportDeclaration,a(),i=r,!0}if(n instanceof U){r=i;return i=f.parent()instanceof AST_ExportDeclaration,n.name.walk(f),i=r,l(function(){n.argnames.forEach(function(e){e.walk(f)}),n.rest&&n.rest.walk(f),Ae(n,f)}),!0}if(n instanceof ee)return n.init_vars(s),a(),!0;if(n instanceof ge)return l(function(){Ae(n,f)}),n.bcatch&&n.bcatch.walk(f),n.bfinally&&n.bfinally.walk(f),!0;if(n instanceof Se){var o=s;do{if((o=o.resolve()).uses_with)break;o.uses_with=!0}while(o=o.parent_scope);return l(a),!0}if(n instanceof De)return l(a),!0;if(n instanceof ne&&(n.scope=s),n instanceof j&&(n.thedef=n,n.references=[]),n instanceof ae)s.def_variable(n).defun=t;else if(n instanceof re){(c=s.def_variable(n)).defun=t,i&&(c.exported=!0)}else if(n instanceof fe){var c=t.def_function(n,f.parent());i&&(c.exported=!0)}else if(n instanceof le)t.def_variable(n);else if(n instanceof _e){c=t.def_function(n,"arguments"==n.name?void 0:t);e.ie&&"arguments"!=n.name&&(c.defun=t.parent_scope.resolve())}else if(n instanceof de){c=s.def_variable(n);i&&(c.exported=!0)}else if(n instanceof me){c=t.def_variable(n,n instanceof ue?void 0:null);i&&(c.exported=!0)}function l(e){n.init_vars(s);var a=t,i=s;n instanceof J&&(t=n),s=n,e(),s=i,t=a}});n.make_def=function(e,n){return new ye(++r,this,e,n)},n.walk(f),n.globals=new p;var c=[];f=new Te(function(t){if(t instanceof T){if(!(t.argname instanceof O))return;return c.push(t),t.argname.walk(f),c.pop(),Ae(t,f),!0}if(t instanceof K)return c.push(t),t.name&&t.name.walk(f),t.argnames.forEach(function(e){e.walk(f)}),t.rest&&t.rest.walk(f),c.pop(),Ee(t,f),!0;if(t instanceof Y)return t.label&&t.label.thedef.references.push(t),!0;if(t instanceof se){var a=t.definition();if(a.preinit=a.references.length,t instanceof ae){if(r=a.redefined())for(var i=t.scope;i&&o(i.enclosed,r)&&i!==r.scope;i=i.parent_scope);}else if(t instanceof re){(r=a.redefined())&&(r.const_redefs=!0)}else if(a.scope!==t.scope&&(t instanceof fe||t instanceof le||t instanceof me)){t.mark_enclosed(e);var r=t.scope.find_variable(t.name);t.thedef!==r&&(t.thedef=r,r.orig.push(t),t.mark_enclosed(e))}return"arguments"!=t.name||((h=t instanceof me&&f.parent())instanceof be&&!h.value||((u=t.scope.resolve().find_variable("arguments"))&&l(u)&&(u.scope.uses_arguments=3),!0))}if(t instanceof pe){for(var s=t.name,u=t.scope.find_variable(s),_=c.length;_>0&&u&&!((_=c.lastIndexOf(u.scope,_-1))<0);){var d=u.orig[0];if(d instanceof ae||d instanceof le||d instanceof _e){t.in_arg=!0;break}u=u.scope.parent_scope.find_variable(s)}if(u){if("arguments"==s&&l(u)){var h;Oe(t,h=f.parent())?u.scope.uses_arguments=3:u.scope.uses_arguments<2&&!(h instanceof AST_PropAccess&&h.expression===t)?u.scope.uses_arguments=2:u.scope.uses_arguments||(u.scope.uses_arguments=!0)}}else u=n.def_global(t);if("eval"==s)if("Call"==(h=f.parent()).TYPE&&h.expression===t){i=t.scope;do{if((i=i.resolve()).uses_eval)break;i.uses_eval=!0}while(i=i.parent_scope)}else u.undeclared&&(n.uses_eval=!0);if(u.init instanceof U&&u.scope!==u.init.name.scope){var p=t.scope;do{if(p===u.init.name.scope)break}while(p=p.parent_scope);p||(u.init=void 0)}return t.thedef=u,t.reference(e),!0}});function l(e){return e.orig[0]instanceof le&&!(e.orig[1]instanceof le||e.orig[2]instanceof le)&&!is_arrow(e.scope)}function u(t,a){var i=t.name,r=t.thedef;if(!all(r.orig,function(e){return!(e instanceof re||e instanceof de)}))return!1;var s=a.find_variable(i);if(s){var o=s.redefined();o&&(s=o)}else s=n.globals.get(i);return s?s.orig.push(t):s=a.def_variable(t),s.undeclared&&n.variables.set(i,s),!!("arguments"==i&&l(r)&&t instanceof _e)||(r.defun=s.scope,r.forEach(function(n){n.redef=r,n.thedef=s,n.reference(e)}),!0)}n.walk(f),e.ie&&n.walk(new Te(function(e){if(e instanceof ae){var n=(t=e.thedef).defun;return"arguments"!=t.name&&n.name instanceof _e&&n.name.name==t.name&&(n=n.parent_scope.resolve()),u(e,n),!0}if(e instanceof _e){var t=e.thedef;return u(e,e.scope.parent_scope.resolve())?void 0!==e.thedef.init?e.thedef.init=!1:t.init&&(e.thedef.init=t.init):t.defun=void 0,!0}}))}),ve.DEFMETHOD("def_global",function(e){var n=this.globals,t=e.name;if(n.has(t))return n.get(t);var a=this.make_def(e);return a.undeclared=!0,a.global=!0,n.set(t,a),a}),De.DEFMETHOD("init_vars",function(e){Me(this,e)}),J.DEFMETHOD("init_vars",function(e){He(this,e)}),m.DEFMETHOD("init_vars",function(e){return He(this,e),this}),g.DEFMETHOD("init_vars",function(e){He(this,e)}),K.DEFMETHOD("init_vars",function(e){return He(this,e),this.uses_arguments=!1,this.def_variable(new le({name:"arguments",scope:this,start:this.start,end:this.end})),this}),ne.DEFMETHOD("mark_enclosed",function(e){for(var n=this.definition(),t=this.scope;t&&o(t.enclosed,n)&&(e?(e.keep_fargs&&t instanceof K&&t.each_argname(function(e){o(n.scope.enclosed,e.definition())}),e.keep_fnames&&t.functions.each(function(e){o(n.scope.enclosed,e)})):t._var_names=void 0,t!==n.scope);t=t.parent_scope);}),ne.DEFMETHOD("reference",function(e){this.definition().references.push(this),this.mark_enclosed(e)}),De.DEFMETHOD("find_variable",function(e){return this.variables.get(e)||this.parent_scope&&this.parent_scope.find_variable(e)}),De.DEFMETHOD("def_function",function(e,n){var t=this.def_variable(e,n);return(!t.init||t.init instanceof U)&&(t.init=n),this.functions.set(e.name,t),t}),De.DEFMETHOD("def_variable",function(e,n){var t=this.variables.get(e.name);return t?(t.orig.push(e),t.init instanceof AST_LambdaExpression&&(t.init=n)):(t=this.make_def(e,n),this.variables.set(e.name,t),t.global=!this.parent_scope),e.thedef=t}),ne.DEFMETHOD("unmangleable",function(e){var n=this.definition();return!n||n.unmangleable(e)}),j.DEFMETHOD("unmangleable",c),ne.DEFMETHOD("definition",function(){return this.thedef}),ve.DEFMETHOD("mangle_names",function(e){if((e=Ce(e)).cache&&e.cache.props){var n=xe(this,e);e.cache.props.each(function(e){n.set(e,!0)})}var t=-1,a=[],i=new Te(function(n,s){var o;if(n instanceof De){n instanceof W&&(o=t),e.webkit&&n instanceof q&&n.init instanceof AST_Let&&n.init.definitions.forEach(function(e){e.name.match_symbol(function(e){if(e instanceof de){var n=e.definition(),t=e.scope.parent_scope,a=t.def_variable(e);e.thedef=n,t.to_mangle.push(a),n.redefined=function(){return a}}})},!0);var f=n.to_mangle=[];if(n.variables.each(function(n){(function(n){var t=n.orig[0],i=n.redefined();if(!i){if(!(t instanceof re))return!1;var r=n.scope.resolve();if(n.scope===r)return!1;if(n.scope.parent_scope.find_variable(t.name))return!1;i=r.def_variable(t),r.to_mangle.push(i)}a.push(n),n.references.forEach(s),(t instanceof ae||t instanceof re)&&(s(t),n.redefined=function(){return i});return!0;function s(t){t.thedef=i,t.reference(e),t.thedef=n}})(n)||f.push(n)}),s(),e.cache&&n instanceof ve&&n.globals.each(r),n instanceof y&&i.has_directive("use asm")){var c=new pe(n.name);c.scope=n,c.reference(e)}if(f.length>36){var l=f.map(function(e,n){return n}).sort(function(e,n){return f[n].references.length-f[e].references.length||e-n});f=l.slice(0,36).sort(function(e,n){return e-n}).map(function(e){return f[e]}).concat(l.slice(36).sort(function(e,n){return e-n}).map(function(e){return f[e]}))}return f.forEach(r),!(n instanceof W)||e.v8&&function(n){var t,a=0;for(;t=n.parent(a++);){if(t instanceof b)return t instanceof ve&&!e.toplevel;if(t instanceof W)return!0}}(i)||(t=o),!0}if(n instanceof j){var u;do{u=Le(++t)}while(we[u]);return n.mangled_name=u,!0}});function r(n){e.reserved.has[n.name]||n.mangle(e)}this.walk(i),a.forEach(r)}),ve.DEFMETHOD("find_colliding_names",function(e){var n=e.cache&&e.cache.props,t=Object.create(we);return e.reserved.forEach(a),this.globals.each(i),this.walk(new Te(function(e){e instanceof De&&e.variables.each(i)})),t;function a(e){t[e]=!0}function i(t){var i=t.name;if(t.global&&n&&n.has(i))i=n.get(i);else if(!t.unmangleable(e))return;a(i)}}),ve.DEFMETHOD("expand_names",function(e){Le.reset(),Le.sort(),e=Ce(e);var n=this.find_colliding_names(e),t=0;function a(a){if(!(a.global&&e.cache||a.unmangleable(e)||e.reserved.has[a.name])){var i=a.redefined(),r=i?i.rename||i.name:function(){var e;do{e=Le(t++)}while(n[e]);return e}();a.rename=r,a.forEach(function(e){e.definition()===a&&(e.name=r)})}}this.globals.each(a),this.walk(new Te(function(e){e instanceof De&&e.variables.each(a)}))}),G.DEFMETHOD("tail_node",l),Q.DEFMETHOD("tail_node",function(){return this.expressions[this.expressions.length-1]}),ve.DEFMETHOD("compute_char_frequency",function(e){e=Ce(e),Le.reset();var n=ne.prototype.add_source_map;try{ne.prototype.add_source_map=function(){this.unmangleable(e)||Le.consider(this.name,-1)},e.properties&&(H.prototype.add_source_map=function(){Le.consider(this.property,-1)},Z.prototype.add_source_map=function(){!function e(n){n instanceof X?Le.consider(n.value,-1):n instanceof E?(e(n.consequent),e(n.alternative)):n instanceof Q&&e(n.tail_node())}(this.property)}),Le.consider(this.print_to_string(),1)}finally{ne.prototype.add_source_map=n,delete H.prototype.add_source_map,delete Z.prototype.add_source_map}Le.sort()});var Le=function(){var e=Object.create(null);function n(n){for(var t=[],a=0;a<n.length;a++){var i=n[a];t.push(i),e[i]=-.01*a}return t}var t,a,i=n("0123456789"),r=n("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_");function s(){t=null,a=Object.create(e)}function o(e,n){return a[n]-a[e]}function f(e){var n=r[e%54];for(e=Math.floor(e/54);--e>=0;e>>=6)n+=t[63&e];return n}return f.consider=function(e,n){for(var t=e.length;--t>=0;)a[e[t]]+=n},f.sort=function(){t=r.sort(o).concat(i).sort(o)},f.reset=s,s(),f}();return{base54:Le,is_lhs:Oe}});
//# sourceMappingURL=sourcemaps/scope.js.map
