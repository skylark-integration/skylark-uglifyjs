/**
 * skylark-uglifyjs - A version of uglifyjs that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["./utils","./ast","./parse"],function(e,n,t){"use strict";const{defaults:a,find_if:i,keep_name:r,mergeSort:s,member:o,push_uniq:f,make_node:c,return_false:u,return_this:l,return_true:_,string_template:d,DEF_BITPROPS:h,makePredicate:p,Dictionary:m}=e,{AST_Arrow:v,AST_Assign:g,AST_AsyncArrow:b,AST_Block:S,AST_Call:T,AST_Catch:A,AST_Class:E,AST_Conditional:D,AST_DefClass:k,AST_Definitions:w,AST_DefaultValue:y,AST_Defun:F,AST_Destructuring:O,AST_Destructured:M,AST_DestructuredKeyVal:H,AST_Dot:x,AST_DotHash:C,AST_Export:L,AST_ExportDeclaration:I,AST_For:R,AST_ForIn:B,AST_ForOf:P,AST_ForEnumeration:V,AST_Function:q,AST_Import:j,AST_IterationStatement:W,AST_Label:N,AST_LabeledStatement:K,AST_LabelRef:U,AST_Lambda:Y,AST_LambdaDefinition:z,AST_LambdaExpression:G,AST_LoopControl:J,AST_NameMapping:Q,AST_Node:X,AST_PropAccess:Z,AST_Scope:$,AST_Sequence:ee,AST_String:ne,AST_Sub:te,AST_Switch:ae,AST_SwitchBranch:ie,AST_Symbol:re,AST_SymbolBlockDeclaration:se,AST_SymbolCatch:oe,AST_SymbolClass:fe,AST_SymbolConst:ce,AST_SymbolDeclaration:ue,AST_SymbolDefClass:le,AST_SymbolDefun:_e,AST_SymbolExport:de,AST_SymbolFunarg:he,AST_SymbolImport:pe,AST_SymbolLambda:me,AST_SymbolLet:ve,AST_SymbolMethod:ge,AST_SymbolRef:be,AST_SymbolVar:Se,AST_Toplevel:Te,AST_Try:Ae,AST_VarDef:Ee,AST_With:De,TreeWalker:ke,walk_body:we,walk_lambda:ye,AST_BlockScope:Fe,AST_Unary:Oe,is_arrow:Me}=n,{RESERVED_WORDS:He}=t;function xe(e,n,t,a){this._bits=0,this.defun=void 0,this.eliminated=0,this.id=e,this.init=a,this.mangled_name=null,this.name=t.name,this.orig=[t],this.references=[],this.replaced=0,this.safe_ids=void 0,this.scope=n}function Ce(e){return e.orig[0]instanceof he||e.orig[1]instanceof he}xe.prototype={forEach:function(e){this.orig.forEach(e),this.references.forEach(e)},mangle:function(e){if(!this.mangled_name){var n=this.global&&e.cache&&e.cache.props;if(n&&n.has(this.name))this.mangled_name=n.get(this.name);else if(this.unmangleable(e))Pe(this.scope,e).set(this.name,!0);else{var t=this.redefined();this.mangled_name=t?t.mangled_name||t.name:function(e,n){var t,a=e.scope,i=Pe(a,n),r=a.cname_holes,s=new m,f=[a];e.forEach(function(e){var t=e.scope;do{if(o(t,f))break;Pe(t,n).each(function(e,n){s.set(n,e)}),f.push(t)}while(t=t.parent_scope)});for(var c=0;c<r.length;c++)if(t=qe(r[c]),!s.has(t))return r.splice(c,1),i.set(t,!0),t;for(;;)if(t=qe(++a.cname),!(i.has(t)||He[t]||n.reserved.has[t])){if(!s.has(t))break;r.push(a.cname)}return i.set(t,!0),t}(this,e),n&&n.set(this.name,this.mangled_name)}}},redefined:function(){var e=this.defun;if(e){var n=this.name,t=e.variables.get(n)||e instanceof Te&&e.globals.get(n)||this.orig[0]instanceof ce&&i(function(e){return e.name==n},e.enclosed);return t&&t!==this?t.redefined()||t:void 0}},unmangleable:function(e){if(this.exported)return!0;if(this.undeclared)return!0;if(!e.eval&&this.scope.pinned())return!0;if(e.keep_fargs&&Ce(this))return!0;if(e.keep_fnames){var n=this.orig[0];if(n instanceof fe)return!0;if(n instanceof le)return!0;if(n instanceof _e)return!0;if(n instanceof me)return!0}return!(e.toplevel||!this.global)}},h(xe,["const_redefs","cross_loop","direct_access","exported","global","undeclared"]);var Le=p("delete ++ --");function Ie(e,n){return n instanceof g?n.left===e&&e:n instanceof y?n.name===e&&e:n instanceof M?e:n instanceof H?e:n instanceof V?n.init===e&&e:n instanceof Oe?Le[n.operator]&&n.expression:void 0}function Re(e,n){e.enclosed=[],e.parent_scope=n,e.functions=new m,e.variables=new m,n&&(e.make_def=n.make_def)}function Be(e,n){Re(e,n),e.uses_eval=!1,e.uses_with=!1}function Pe(e,n){var t=e.names_in_use;if(!t){e.cname=-1,e.cname_holes=[],e.names_in_use=t=new m;var a=n.cache&&n.cache.props;e.enclosed.forEach(function(e){e.unmangleable(n)&&t.set(e.name,!0),e.global&&a&&a.has(e.name)&&t.set(a.get(e.name),!0)})}return t}function Ve(e){return e=a(e,{eval:!1,ie:!1,keep_fargs:!1,keep_fnames:!1,reserved:[],toplevel:!1,v8:!1,webkit:!1}),Array.isArray(e.reserved)||(e.reserved=[]),f(e.reserved,"arguments"),e.reserved.has=p(e.reserved),e}Te.DEFMETHOD("figure_out_scope",function(e){e=a(e,{cache:null,ie:!1});var n=this,t=null,i=!1,r=0,s=n.parent_scope=null,o=new ke(function(n,a){if(n instanceof k){var r=i;return i=o.parent()instanceof I,n.name.walk(o),i=r,u(function(){n.extends&&n.extends.walk(o),n.properties.forEach(function(e){e.walk(o)})}),!0}if(n instanceof w){r=i;return i=o.parent()instanceof I,a(),i=r,!0}if(n instanceof z){r=i;return i=o.parent()instanceof I,n.name.walk(o),i=r,u(function(){n.argnames.forEach(function(e){e.walk(o)}),n.rest&&n.rest.walk(o),we(n,o)}),!0}if(n instanceof ie)return n.init_vars(s),a(),!0;if(n instanceof Ae)return u(function(){we(n,o)}),n.bcatch&&n.bcatch.walk(o),n.bfinally&&n.bfinally.walk(o),!0;if(n instanceof De){var f=s;do{if((f=f.resolve()).uses_with)break;f.uses_with=!0}while(f=f.parent_scope);return u(a),!0}if(n instanceof Fe)return u(a),!0;if(n instanceof re&&(n.scope=s),n instanceof N&&(n.thedef=n,n.references=[]),n instanceof oe)s.def_variable(n).defun=t;else if(n instanceof ce){(c=s.def_variable(n)).defun=t,i&&(c.exported=!0)}else if(n instanceof _e){var c=t.def_function(n,o.parent());i&&(c.exported=!0)}else if(n instanceof he)t.def_variable(n);else if(n instanceof me){c=t.def_function(n,"arguments"==n.name?void 0:t);e.ie&&"arguments"!=n.name&&(c.defun=t.parent_scope.resolve())}else if(n instanceof ve){c=s.def_variable(n);i&&(c.exported=!0)}else if(n instanceof Se){c=t.def_variable(n,n instanceof pe?void 0:null);i&&(c.exported=!0)}function u(e){n.init_vars(s);var a=t,i=s;n instanceof $&&(t=n),s=n,e(),s=i,t=a}});n.make_def=function(e,n){return new xe(++r,this,e,n)},n.walk(o),n.globals=new m;var c=[];o=new ke(function(t){if(t instanceof A){if(!(t.argname instanceof M))return;return c.push(t),t.argname.walk(o),c.pop(),we(t,o),!0}if(t instanceof Y)return c.push(t),t.name&&t.name.walk(o),t.argnames.forEach(function(e){e.walk(o)}),t.rest&&t.rest.walk(o),c.pop(),ye(t,o),!0;if(t instanceof J)return t.label&&t.label.thedef.references.push(t),!0;if(t instanceof ue){var a=t.definition();if(a.preinit=a.references.length,t instanceof oe){if(r=a.redefined())for(var i=t.scope;i&&f(i.enclosed,r)&&i!==r.scope;i=i.parent_scope);}else if(t instanceof ce){(r=a.redefined())&&(r.const_redefs=!0)}else if(a.scope!==t.scope&&(t instanceof _e||t instanceof he||t instanceof Se)){t.mark_enclosed(e);var r=t.scope.find_variable(t.name);t.thedef!==r&&(t.thedef=r,r.orig.push(t),t.mark_enclosed(e))}return"arguments"!=t.name||((h=t instanceof Se&&o.parent())instanceof Ee&&!h.value||((l=t.scope.resolve().find_variable("arguments"))&&u(l)&&(l.scope.uses_arguments=3),!0))}if(t instanceof be){for(var s=t.name,l=t.scope.find_variable(s),_=c.length;_>0&&l&&!((_=c.lastIndexOf(l.scope,_-1))<0);){var d=l.orig[0];if(d instanceof oe||d instanceof he||d instanceof me){t.in_arg=!0;break}l=l.scope.parent_scope.find_variable(s)}if(l){if("arguments"==s&&u(l)){var h;Ie(t,h=o.parent())?l.scope.uses_arguments=3:l.scope.uses_arguments<2&&!(h instanceof Z&&h.expression===t)?l.scope.uses_arguments=2:l.scope.uses_arguments||(l.scope.uses_arguments=!0)}}else l=n.def_global(t);if("eval"==s)if("Call"==(h=o.parent()).TYPE&&h.expression===t){i=t.scope;do{if((i=i.resolve()).uses_eval)break;i.uses_eval=!0}while(i=i.parent_scope)}else l.undeclared&&(n.uses_eval=!0);if(l.init instanceof z&&l.scope!==l.init.name.scope){var p=t.scope;do{if(p===l.init.name.scope)break}while(p=p.parent_scope);p||(l.init=void 0)}return t.thedef=l,t.reference(e),!0}});function u(e){return e.orig[0]instanceof he&&!(e.orig[1]instanceof he||e.orig[2]instanceof he)&&!Me(e.scope)}function l(t,a){var i=t.name,r=t.thedef;if(!all(r.orig,function(e){return!(e instanceof ce||e instanceof ve)}))return!1;var s=a.find_variable(i);if(s){var o=s.redefined();o&&(s=o)}else s=n.globals.get(i);return s?s.orig.push(t):s=a.def_variable(t),s.undeclared&&n.variables.set(i,s),!!("arguments"==i&&u(r)&&t instanceof me)||(r.defun=s.scope,r.forEach(function(n){n.redef=r,n.thedef=s,n.reference(e)}),!0)}n.walk(o),e.ie&&n.walk(new ke(function(e){if(e instanceof oe){var n=(t=e.thedef).defun;return"arguments"!=t.name&&n.name instanceof me&&n.name.name==t.name&&(n=n.parent_scope.resolve()),l(e,n),!0}if(e instanceof me){var t=e.thedef;return l(e,e.scope.parent_scope.resolve())?void 0!==e.thedef.init?e.thedef.init=!1:t.init&&(e.thedef.init=t.init):t.defun=void 0,!0}}))}),Te.DEFMETHOD("def_global",function(e){var n=this.globals,t=e.name;if(n.has(t))return n.get(t);var a=this.make_def(e);return a.undeclared=!0,a.global=!0,n.set(t,a),a}),Fe.DEFMETHOD("init_vars",function(e){Re(this,e)}),$.DEFMETHOD("init_vars",function(e){Be(this,e)}),v.DEFMETHOD("init_vars",function(e){return Be(this,e),this}),b.DEFMETHOD("init_vars",function(e){Be(this,e)}),Y.DEFMETHOD("init_vars",function(e){return Be(this,e),this.uses_arguments=!1,this.def_variable(new he({name:"arguments",scope:this,start:this.start,end:this.end})),this}),re.DEFMETHOD("mark_enclosed",function(e){for(var n=this.definition(),t=this.scope;t&&f(t.enclosed,n)&&(e?(e.keep_fargs&&t instanceof Y&&t.each_argname(function(e){f(n.scope.enclosed,e.definition())}),e.keep_fnames&&t.functions.each(function(e){f(n.scope.enclosed,e)})):t._var_names=void 0,t!==n.scope);t=t.parent_scope);}),re.DEFMETHOD("reference",function(e){this.definition().references.push(this),this.mark_enclosed(e)}),Fe.DEFMETHOD("find_variable",function(e){return this.variables.get(e)||this.parent_scope&&this.parent_scope.find_variable(e)}),Fe.DEFMETHOD("def_function",function(e,n){var t=this.def_variable(e,n);return(!t.init||t.init instanceof z)&&(t.init=n),this.functions.set(e.name,t),t}),Fe.DEFMETHOD("def_variable",function(e,n){var t=this.variables.get(e.name);return t?(t.orig.push(e),t.init instanceof G&&(t.init=n)):(t=this.make_def(e,n),this.variables.set(e.name,t),t.global=!this.parent_scope),e.thedef=t}),re.DEFMETHOD("unmangleable",function(e){var n=this.definition();return!n||n.unmangleable(e)}),N.DEFMETHOD("unmangleable",u),re.DEFMETHOD("definition",function(){return this.thedef}),Te.DEFMETHOD("mangle_names",function(e){if((e=Ve(e)).cache&&e.cache.props){var n=Pe(this,e);e.cache.props.each(function(e){n.set(e,!0)})}var t=-1,a=[],i=new ke(function(n,s){var o;if(n instanceof Fe){n instanceof K&&(o=t),e.webkit&&n instanceof W&&n.init instanceof AST_Let&&n.init.definitions.forEach(function(e){e.name.match_symbol(function(e){if(e instanceof ve){var n=e.definition(),t=e.scope.parent_scope,a=t.def_variable(e);e.thedef=n,t.to_mangle.push(a),n.redefined=function(){return a}}})},!0);var f=n.to_mangle=[];if(n.variables.each(function(n){(function(n){var t=n.orig[0],i=n.redefined();if(!i){if(!(t instanceof ce))return!1;var r=n.scope.resolve();if(n.scope===r)return!1;if(n.scope.parent_scope.find_variable(t.name))return!1;i=r.def_variable(t),r.to_mangle.push(i)}a.push(n),n.references.forEach(s),(t instanceof oe||t instanceof ce)&&(s(t),n.redefined=function(){return i});return!0;function s(t){t.thedef=i,t.reference(e),t.thedef=n}})(n)||f.push(n)}),s(),e.cache&&n instanceof Te&&n.globals.each(r),n instanceof F&&i.has_directive("use asm")){var c=new be(n.name);c.scope=n,c.reference(e)}if(f.length>36){var u=f.map(function(e,n){return n}).sort(function(e,n){return f[n].references.length-f[e].references.length||e-n});f=u.slice(0,36).sort(function(e,n){return e-n}).map(function(e){return f[e]}).concat(u.slice(36).sort(function(e,n){return e-n}).map(function(e){return f[e]}))}return f.forEach(r),!(n instanceof K)||e.v8&&function(n){var t,a=0;for(;t=n.parent(a++);){if(t instanceof S)return t instanceof Te&&!e.toplevel;if(t instanceof K)return!0}}(i)||(t=o),!0}if(n instanceof N){var l;do{l=qe(++t)}while(He[l]);return n.mangled_name=l,!0}});function r(n){e.reserved.has[n.name]||n.mangle(e)}this.walk(i),a.forEach(r)}),Te.DEFMETHOD("find_colliding_names",function(e){var n=e.cache&&e.cache.props,t=Object.create(He);return e.reserved.forEach(a),this.globals.each(i),this.walk(new ke(function(e){e instanceof Fe&&e.variables.each(i)})),t;function a(e){t[e]=!0}function i(t){var i=t.name;if(t.global&&n&&n.has(i))i=n.get(i);else if(!t.unmangleable(e))return;a(i)}}),Te.DEFMETHOD("expand_names",function(e){qe.reset(),qe.sort(),e=Ve(e);var n=this.find_colliding_names(e),t=0;function a(a){if(!(a.global&&e.cache||a.unmangleable(e)||e.reserved.has[a.name])){var i=a.redefined(),r=i?i.rename||i.name:function(){var e;do{e=qe(t++)}while(n[e]);return e}();a.rename=r,a.forEach(function(e){e.definition()===a&&(e.name=r)})}}this.globals.each(a),this.walk(new ke(function(e){e instanceof Fe&&e.variables.each(a)}))}),X.DEFMETHOD("tail_node",l),ee.DEFMETHOD("tail_node",function(){return this.expressions[this.expressions.length-1]}),Te.DEFMETHOD("compute_char_frequency",function(e){e=Ve(e),qe.reset();var n=re.prototype.add_source_map;try{re.prototype.add_source_map=function(){this.unmangleable(e)||qe.consider(this.name,-1)},e.properties&&(x.prototype.add_source_map=function(){qe.consider(this.property,-1)},te.prototype.add_source_map=function(){!function e(n){n instanceof ne?qe.consider(n.value,-1):n instanceof D?(e(n.consequent),e(n.alternative)):n instanceof ee&&e(n.tail_node())}(this.property)}),qe.consider(this.print_to_string(),1)}finally{re.prototype.add_source_map=n,delete x.prototype.add_source_map,delete te.prototype.add_source_map}qe.sort()});var qe=function(){var e=Object.create(null);function n(n){for(var t=[],a=0;a<n.length;a++){var i=n[a];t.push(i),e[i]=-.01*a}return t}var t,a,i=n("0123456789"),r=n("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_");function s(){t=null,a=Object.create(e)}function o(e,n){return a[n]-a[e]}function f(e){var n=r[e%54];for(e=Math.floor(e/54);--e>=0;e>>=6)n+=t[63&e];return n}return f.consider=function(e,n){for(var t=e.length;--t>=0;)a[e[t]]+=n},f.sort=function(){t=r.sort(o).concat(i).sort(o)},f.reset=s,s(),f}();return{base54:qe,is_lhs:Ie,is_funarg:Ce,unary_side_effects:Le}});
//# sourceMappingURL=sourcemaps/scope.js.map
